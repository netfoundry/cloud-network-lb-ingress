locals {
  user_data = [ for s in var.er_map : <<EOF
#cloud-config
package_update: true
packages:
  - keepalived
write_files:
- encoding: b64
  content: "IyEvYmluL2Jhc2gKaWYgW1sgJEVVSUQgLW5lIDAgXV07IHRoZW4KICAgZWNobyAiVGhpcyBzY3JpcHQgbXVzdCBiZSBydW4gYXMgcm9vdCIgCiAgIGV4aXQgMQpmaQpJTlRFUkZBQ0U9Ik5PTkUiCklQPSJOT05FIgpQUkVGSVg9Ik5PTkUiCkdXPSJOT05FIgpETlNTRVJWRVJTPSJOT05FIgpETlNTVUZGSVg9Ik5PTkUiCk1UVT0iTk9ORSIKUFJPTVBUPSJ5ZXMiCmZvciBpIGluICIkQCIKZG8KICBjYXNlICRpIGluCiAgICAtLXR5cGU9KnwtdHA9KikKICAgICAgICBUWVBFPSIke2kjKj19IgogICAgICAgIHNoaWZ0ICMgcGFzdCBhcmd1bWVudD12YWx1ZQogICAgICAgIDs7ICAKICAgIC0taW50ZXJmYWNlPSp8LWluPSopCiAgICAgICAgSU5URVJGQUNFPSIke2kjKj19IgogICAgICAgIHNoaWZ0ICMgcGFzdCBhcmd1bWVudD12YWx1ZQogICAgICAgIDs7CiAgICAtLWlwPSp8LWlwPSopCiAgICAgICAgSVA9IiR7aSMqPX0iCiAgICAgICAgc2hpZnQgIyBwYXN0IGFyZ3VtZW50PXZhbHVlCiAgICAgICAgOzsKICAgIC0tcHJlZml4PSp8LXByPSopCiAgICAgICAgUFJFRklYPSIke2kjKj19IgogICAgICAgIHNoaWZ0ICMgcGFzdCBhcmd1bWVudD12YWx1ZQogICAgICAgIDs7CiAgICAtLWd3PSp8LWd3PSopCiAgICAgICAgR1c9IiR7aSMqPX0iCiAgICAgICAgc2hpZnQgIyBwYXN0IGFyZ3VtZW50PXZhbHVlCiAgICAgICAgOzsKICAgIC0tZG5zLXNlcnZlcnM9KnwtZHM9KikKICAgICAgICBETlNTRVJWRVJTPSIke2kjKj19IgogICAgICAgIHNoaWZ0ICMgcGFzdCBhcmd1bWVudD12YWx1ZQogICAgICAgIDs7CiAgICAtLWRucy1zdWZmaXg9KnwtZHg9KikKICAgICAgICBETlNTVUZGSVg9IiR7aSMqPX0iCiAgICAgICAgc2hpZnQgIyBwYXN0IGFyZ3VtZW50PXZhbHVlCiAgICAgICAgOzsKICAgIC0tbXR1PSp8LW10dT0qKQogICAgICAgIE1UVT0iJHtpIyo9fSIKICAgICAgICBzaGlmdCAjIHBhc3QgYXJndW1lbnQ9dmFsdWUKICAgICAgICA7OwogICAgLWZ8LS1mb3JjZSkKICAgIFBST01QVD0ibm8iCiAgICBzaGlmdCAjIHBhc3QgYXJndW1lbnQ9dmFsdWUKICAgICAgICA7OwogICAgLWh8LS1oZWxwKQogICAgICAgIGVjaG8gIiIKICAgICAgICBlY2hvICIgICQwIDxvcHRpb25zPiIKICAgICAgICBlY2hvICIgICAgIC0tdHlwZT08dHlwZT4gfCAtdHA9PHR5cGU+IgogICAgICAgIGVjaG8gIiAgICAgLS1pbnRlcmZhY2U9PGludGVyZmFjZSBuYW1lPiB8IC1pbj08aW50ZXJmYWNlIG5hbWU+IgogICAgICAgIGVjaG8gIiAgICAgLS1pcD08aXBfYWRkcmVzcz4gfCAtaXA9PGlwX2FkZHJlc3M+IgogICAgICAgIGVjaG8gIiAgICAgLS1wcmVmaXg9PHN1Ym5ldCBwcmVmaXg+IHwgLXByPTxzdWJuZXQgcHJlZml4PiIKICAgICAgICBlY2hvICIgICAgIC0tZ3c9PGdhdGV3YXkgYWRkcmVzcz4gfCAtZ3c9PGdhdGV3YXkgYWRkcmVzcz4iCiAgICAgICAgZWNobyAiICAgICAtLWRucy1zZXJ2ZXJzPTxkbnMgc2VydmVycz4gfCAtZHM9PGRucyBzZXJ2ZXJzPiIKICAgICAgICBlY2hvICIgICAgIC0tZG5zLXN1ZmZpeD08ZG5zIHNlYXJjaCBkb21haW4+IHwgLWR4PTxkbnMgc2VhcmNoIGRvbWFpbj4iCiAgICAgICAgZWNobyAiICAgICAtLW10dT08bXR1IGxlbmd0aD4gfCAtZHg9PGRucyBzZWFyY2ggZG9tYWluPiIKICAgICAgICBlY2hvICIiCiAgICAgICAgZWNobyAiICAgICAtaCB8IC0taGVscCAgICAgRGlzcGxheSB0aGlzIGhlbHAiCiAgICAgICAgZWNobyAiICAgICAtZiB8IC0tZm9yY2UgICAgT3B0aW9uIHRvIG5vdCBwcm9tcHQgZm9yIGlucHV0IgogICAgICAgIGVjaG8gIiIKICAgICAgICBlY2hvICJTdGF0aWMgZXhhbXBsZXM6IgogICAgICAgIGVjaG8gImV4YW1wbGU6ICQwIC10cD1zdGF0aWMgLWlwPTEwLjAuMC4xMCAtcHI9MjQgLWd3PTEwLjAuMC4xIC1kbj1cIjguOC44LjgsOC44LjQuNFwiIC1keD1cIm5mZG9taWFuLmlvXCIgLWluPVwiZW5vMVwiIC1tdHU9XCI5MDAwXCIgLWYiCiAgICAgICAgZWNobyAiZXhhbXBsZTogJDAgLS1pcD0xMC4wLjAuMTAgLS1wcmVmaXg9MjQgLS1ndz0xMC4wLjAuMSAtLWRucy1zZXJ2ZXJzPVwiOC44LjguOCw4LjguNC40XCIgLS1kbnMtc3VmZml4PVwibmZkb21pYW4uaW9cIiAtLWludGVyZmFjZT1cImVubzFcIiAtLW10dT1cIjkwMDBcIiAtZiIKICAgICAgICBlY2hvICIiCiAgICAgICAgZWNobyAiRHluYW1pYyBleGFtcGxlczoiCiAgICAgICAgZWNobyAiZXhhbXBsZTogJDAgLXRwPWR5bmFtaWMgLWluPVwiZW5vMVwiIC1tdHU9XCI5MDAwXCIiCiAgICAgICAgZWNobyAiZXhhbXBsZTogJDAgLS10eXBlPWR5bmFtaWMgLS1pbnRlcmZhY2U9XCJlbm8xXCIgLS1tdHU9XCI5MDAwXCIiCiAgICAgICAgZXhpdAogICAgOzsKICAgICopCiAgICAgICAgZWNobyAiVW5rbm93biBPcHRpb246ICRpIgogICAgICAgICAgIyB1bmtub3duIG9wdGlvbgogICAgOzsKICBlc2FjCmRvbmUKaWYgW1sgJHtQUk9NUFR9ID09ICJ5ZXMiIF1dOyB0aGVuCiAgICAjIGNob29zZSBhbiBpbnRlcmZhY2UKICAgIElOVEVSRkFDRT0iIgogICAgd2hpbGUgWyAteiAkSU5URVJGQUNFIF07IGRvCiAgICAgICAgaW50ZXJmYWNlX2xpc3Q9JChscyAvc3lzL2NsYXNzL25ldCB8IGdyZXAgLXYgbG8pCiAgICAgICAgZWNobyAtZSAiXG5TRUxFQ1QgVEhFIElOVEVSRkFDRSBZT1UgV0FOVCBUTyBNQU5BR0UiCiAgICAgICAgc2VsZWN0IHNlbGVjdGVkX2ludGVyZmFjZSBpbiAkaW50ZXJmYWNlX2xpc3QKICAgICAgICBkbyAKICAgICAgICAgICAgSU5URVJGQUNFPSRzZWxlY3RlZF9pbnRlcmZhY2UKICAgICAgICAgICAgYnJlYWsKICAgICAgICBkb25lCiAgICBkb25lCiAgICBUWVBFPSIiCiAgICB3aGlsZSBbIC16ICRUWVBFIF07IGRvCiAgICAgICAgZWNobyAtZSAiXG5TRUxFQ1QgU1RBVElDIG9yIERZTkFNSUMoREhDUCkiCiAgICAgICAgc2VsZWN0IGNvbmZpZ3VyYXRpb25fdHlwZSBpbiBzdGF0aWMgZHluYW1pYwogICAgICAgIGRvCiAgICAgICAgICAgIFRZUEU9JGNvbmZpZ3VyYXRpb25fdHlwZQogICAgICAgICAgICBicmVhawogICAgICAgIGRvbmUKICAgIGRvbmUKICAgIGlmIFtbICRUWVBFID09ICJzdGF0aWMiIF1dOyB0aGVuCgogICAgICAgIHdoaWxlIFsgJHtQUk9NUFR9ID09ICJ5ZXMiIF07IGRvCiAgICAgICAgICAgIGVjaG8gIiIKICAgICAgICAgICAgZWNobyAiKCopSU5URVJGQUNFICAgPSAke0lOVEVSRkFDRX0iCiAgICAgICAgICAgIGVjaG8gIigyKUlQICAgICAgICAgID0gJHtJUH0iCiAgICAgICAgICAgIGVjaG8gIigzKVBSRUZJWCAgICAgID0gJHtQUkVGSVh9IgogICAgICAgICAgICBlY2hvICIoNClHVyAgICAgICAgICA9ICR7R1d9IgogICAgICAgICAgICBlY2hvICIoNSlETlNTRVJWRVJTICA9ICR7RE5TU0VSVkVSU30iCiAgICAgICAgICAgIGVjaG8gIig2KUROU1NVRkZJWCAgID0gJHtETlNTVUZGSVh9IgogICAgICAgICAgICBlY2hvICIoNylNVFUgICAgICAgICA9ICR7TVRVfSIKICAgICAgICAgICAgZWNobyAiICIKICAgICAgICAgICAgZWNobyAiRW50ZXIgdGhlIGxpbmUgbnVtYmVyIHRvIG1vZGlmeSwgb3IgXCIwXCIgdG8gZmluaXNoIGlucHV0ID4iCiAgICAgICAgICAgIHJlYWQgTU9ETlVNQkVSCiAgICAgICAgICAgIGlmIFtbICR7TU9ETlVNQkVSfSA9PSAiMCIgXV07IHRoZW4KICAgICAgICAgICAgICAgIGlmIFtbICR7SU5URVJGQUNFfSA9PSAiTk9ORSIgfHwgJHtJUH0gPT0gIk5PTkUiIHx8ICR7UFJFRklYfSA9PSAiTk9ORSIgXV07IHRoZW4KICAgICAgICAgICAgICAgICAgICBlY2hvICIiCiAgICAgICAgICAgICAgICAgICAgZWNobyAiPDxFUlJPUj4+IFJlcXVpcmVkIHBhcmFtZXRlcnMgbWlzc2luZy4gUmVxdWlyZXMgSVAsIFBSRUZJWCBhbmQgSU5URVJGQUNFIgogICAgICAgICAgICAgICAgICAgIGVjaG8gIiIKICAgICAgICAgICAgICAgIGVsaWYgW1sgISAtZCAvc3lzL2NsYXNzL25ldC8ke0lOVEVSRkFDRX0gXV07IHRoZW4KICAgICAgICAgICAgICAgICAgICBlY2hvICIiCiAgICAgICAgICAgICAgICAgICAgZWNobyAiPDxFUlJPUj4+IEludGVyZmFjZTogJHtJTlRFUkZBQ0V9IGRvZXMgbm90IGV4aXN0IgogICAgICAgICAgICAgICAgICAgIGVjaG8gIiIKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBQUk9NUFQ9Im5vIgogICAgICAgICAgICAgICAgZmkKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgY2FzZSAke01PRE5VTUJFUn0gaW4KICAgICAgICAgICAgICAgICAgICAyKQogICAgICAgICAgICAgICAgICAgICAgICBlY2hvICIiCiAgICAgICAgICAgICAgICAgICAgICAgIGVjaG8gIkVudGVyIElQID4iCiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWQgSVAKICAgICAgICAgICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgICAgICAgICAzKQogICAgICAgICAgICAgICAgICAgICAgICBlY2hvICIiCiAgICAgICAgICAgICAgICAgICAgICAgIGVjaG8gIkVudGVyIFByZWZpeCA+IgogICAgICAgICAgICAgICAgICAgICAgICByZWFkIFBSRUZJWAogICAgICAgICAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICAgICAgICAgIDQpCiAgICAgICAgICAgICAgICAgICAgICAgIGVjaG8gIiIKICAgICAgICAgICAgICAgICAgICAgICAgZWNobyAiRW50ZXIgR2F0ZXdheSBJUCBBZGRyZXNzID4iCiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWQgR1cKICAgICAgICAgICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgICAgICAgICA1KQogICAgICAgICAgICAgICAgICAgICAgICBlY2hvICIiCiAgICAgICAgICAgICAgICAgICAgICAgIGVjaG8gIkVudGVyIEROUyBTZXJ2ZXJzID4iCiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWQgRE5TU0VSVkVSUwogICAgICAgICAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICAgICAgICAgIDYpCiAgICAgICAgICAgICAgICAgICAgICAgIGVjaG8gIiIKICAgICAgICAgICAgICAgICAgICAgICAgZWNobyAiRW50ZXIgRE5TIFN1ZmZpeCA+IgogICAgICAgICAgICAgICAgICAgICAgICByZWFkIEROU1NVRkZJWAogICAgICAgICAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICAgICAgICAgIDcpCiAgICAgICAgICAgICAgICAgICAgICAgIGVjaG8gIiIKICAgICAgICAgICAgICAgICAgICAgICAgZWNobyAiRW50ZXIgTVRVID4iCiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWQgTVRVCiAgICAgICAgICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgICAgICAgICAgKikKICAgICAgICAgICAgICAgICAgICAgICAgIyB1bmtub3duIG9wdGlvbgogICAgICAgICAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICAgICAgZXNhYwogICAgICAgICAgICBmaQogICAgICAgIGRvbmUgIAogICAgZWxzZQogICAgICAgIHdoaWxlIFsgJHtQUk9NUFR9ID09ICJ5ZXMiIF07IGRvCiAgICAgICAgICAgIGVjaG8gIiIKICAgICAgICAgICAgZWNobyAiKCopSU5URVJGQUNFICAgPSAke0lOVEVSRkFDRX0gKERIQ1ApIgogICAgICAgICAgICBlY2hvICIoMSlNVFUgICAgICAgICA9ICR7TVRVfSIKICAgICAgICAgICAgZWNobyAiICIKICAgICAgICAgICAgZWNobyAiRW50ZXIgdGhlIGxpbmUgbnVtYmVyIHRvIG1vZGlmeSwgb3IgXCIwXCIgdG8gZmluaXNoIGlucHV0ID4iCiAgICAgICAgICAgIHJlYWQgTU9ETlVNQkVSCiAgICAgICAgICAgIGlmIFtbICR7TU9ETlVNQkVSfSA9PSAiMCIgXV07IHRoZW4KICAgICAgICAgICAgICAgIFBST01QVD0ibm8iCiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGNhc2UgJHtNT0ROVU1CRVJ9IGluCiAgICAgICAgICAgICAgICAgICAgMSkKICAgICAgICAgICAgICAgICAgICAgICAgZWNobyAiIgogICAgICAgICAgICAgICAgICAgICAgICBlY2hvICJFbnRlciBNVFUgPiIKICAgICAgICAgICAgICAgICAgICAgICAgcmVhZCBNVFUKICAgICAgICAgICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgICAgICAgICAqKQogICAgICAgICAgICAgICAgICAgICAgICAjIHVua25vd24gb3B0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgICAgICBlc2FjCiAgICAgICAgICAgIGZpCiAgICAgICAgZG9uZQogICAgZmkKZWxzZQogICAgaWYgW1sgISAtZCAvc3lzL2NsYXNzL25ldC8ke0lOVEVSRkFDRX0gXV07IHRoZW4KICAgICAgICBlY2hvICI8PEVSUk9SPj4gSW50ZXJmYWNlOiAke0lOVEVSRkFDRX0gZG9lcyBub3QgZXhpc3QiCiAgICAgICAgZXhpdCAxCiAgICBmaQpmaSAKcmVhZCBNQUMgPC9zeXMvY2xhc3MvbmV0LyR7SU5URVJGQUNFfS9hZGRyZXNzCmlmIFtbICR7VFlQRX0gPT0gInN0YXRpYyIgXV07IHRoZW4KCiAgICBpZiBbWyAke1RZUEV9ID09ICJOT05FIiB8fCAke0lOVEVSRkFDRX0gPT0gIk5PTkUiIHx8ICR7SVB9ID09ICJOT05FIiB8fCAke1BSRUZJWH0gPT0gIk5PTkUiIF1dOyB0aGVuCiAgICAgICAgZWNobyAiPDxFUlJPUj4+IFJlcXVpcmVkIHBhcmFtZXRlcnMgbWlzc2luZy4gUmVxdWlyZXMgVFlQRSwgSVAsIFBSRUZJWCBhbmQgSU5URVJGQUNFIgogICAgICAgIGV4aXQgMQogICAgZmkKCiAgICAjIHdyaXRlIHRoZSBzdGF0aWMgY29uZmlnIGZpbGUgKHVzZXIgaW5wdXQpCiAgICBORVRDRkdfRklMRT0iMDEtbmV0Y2ZnLSR7SU5URVJGQUNFfS55YW1sIgogICAgZWNobyAiIyBUaGlzIGlzIHRoZSBuZXR3b3JrIGNvbmZpZyB3cml0dGVuIGJ5ICckMCcgc2NyaXB0IiA+JHtORVRDRkdfRklMRX0KICAgIGVjaG8gIm5ldHdvcms6IiA+PiR7TkVUQ0ZHX0ZJTEV9CiAgICBlY2hvICIgIGV0aGVybmV0czoiID4+JHtORVRDRkdfRklMRX0KICAgIGVjaG8gIiAgICAke0lOVEVSRkFDRX06IiA+PiR7TkVUQ0ZHX0ZJTEV9CiAgICBlY2hvICIgICAgICBkaGNwNDogbm8iID4+JHtORVRDRkdfRklMRX0KICAgIGVjaG8gIiAgICAgIGFkZHJlc3NlczogWyR7SVB9LyR7UFJFRklYfV0iID4+JHtORVRDRkdfRklMRX0KICAgIGVjaG8gIiAgICAgIG1hdGNoOiIgPj4ke05FVENGR19GSUxFfQogICAgZWNobyAiICAgICAgICBtYWNhZGRyZXNzOiAkTUFDIiA+PiR7TkVUQ0ZHX0ZJTEV9CgogICAgaWYgW1sgJHtHV30gPT0gIk5PTkUiIF1dOyB0aGVuCiAgICAgICAgZWNobyAiTm90IHdyaXRpbmcgR2F0ZXdheSBBZGRyZXNzIHNpbmNlIGl0IGlzIG5vdCBzdXBwbGllZCBieSB1c2VyIgogICAgZWxzZQogICAgICAgIGVjaG8gIiAgICAgIHJvdXRlczoiID4+JHtORVRDRkdfRklMRX0KICAgICAgICBlY2hvICIgICAgICAgIC0gdG86IGRlZmF1bHQiID4+JHtORVRDRkdfRklMRX0KICAgICAgICBlY2hvICIgICAgICAgICAgdmlhOiAke0dXfSIgPj4ke05FVENGR19GSUxFfQogICAgZmkKCiAgICAjIHdyaXRlIE1UVSBpZiBpdCBpcyBzdXBwbGllZCBieSB1c2VyCiAgICBpZiBbWyAke01UVX0gIT0gIk5PTkUiIF1dOyB0aGVuCiAgICAgICAgZWNobyAiICAgICAgbXR1OiAke01UVX0iID4+JHtORVRDRkdfRklMRX0KICAgIGZpCgogICAgIyBvbmx5IHdyaXRlIG5hbWUgc2VydmVycyBpZiBvbmUgb2YgdGhlIGRucyBlbnRyaWVzIGFyZSBwcmVzZW50ZWQKICAgIGlmIFtbICR7RE5TU0VSVkVSU30gIT0gIk5PTkUiIHx8ICR7RE5TU1VGRklYfSAhPSAiTk9ORSIgXV07IHRoZW4KICAgICAgICBlY2hvICIgICAgICBuYW1lc2VydmVyczoiID4+JHtORVRDRkdfRklMRX0KICAgICAgICBpZiBbWyAke0ROU1NFUlZFUlN9ICE9ICJOT05FIiBdXTsgdGhlbgogICAgICAgICAgICBlY2hvICIgICAgICAgIGFkZHJlc3NlczogWyR7RE5TU0VSVkVSU31dIiA+PiR7TkVUQ0ZHX0ZJTEV9CiAgICAgICAgZmkKCiAgICAgICAgaWYgW1sgJHtETlNTVUZGSVh9ICE9ICJOT05FIiBdXTsgdGhlbgogICAgICAgICAgICBlY2hvICIgICAgICAgIHNlYXJjaDogWyR7RE5TU1VGRklYfV0iID4+JHtORVRDRkdfRklMRX0KICAgICAgICBmaQogICAgZmkKZWxzZQogICAgaWYgW1sgJHtUWVBFfSA9PSAiTk9ORSIgfHwgJHtJTlRFUkZBQ0V9ID09ICJOT05FIiBdXTsgdGhlbgogICAgICAgIGVjaG8gIjw8RVJST1I+PiBSZXF1aXJlZCBwYXJhbWV0ZXJzIG1pc3NpbmcuIFJlcXVpcmVzIFRZUEUgYW5kIElOVEVSRkFDRSIKICAgICAgICBleGl0IDEKICAgIGZpCiAgICAjIHdyaXRlIHRoZSBzdGF0aWMgY29uZmlnIGZpbGUgKHVzZXIgaW5wdXQpCiAgICBORVRDRkdfRklMRT0iMDEtbmV0Y2ZnLSR7SU5URVJGQUNFfS55YW1sIgogICAgZWNobyAiIyBUaGlzIGlzIHRoZSBuZXR3b3JrIGNvbmZpZyB3cml0dGVuIGJ5ICckMCcgc2NyaXB0IiA+JHtORVRDRkdfRklMRX0KICAgIGVjaG8gIm5ldHdvcms6IiA+PiR7TkVUQ0ZHX0ZJTEV9CiAgICBlY2hvICIgIGV0aGVybmV0czoiID4+JHtORVRDRkdfRklMRX0KICAgIGVjaG8gIiAgICAke0lOVEVSRkFDRX06IiA+PiR7TkVUQ0ZHX0ZJTEV9CiAgICBlY2hvICIgICAgICBkaGNwNDogeWVzIiA+PiR7TkVUQ0ZHX0ZJTEV9CiAgICBlY2hvICIgICAgICBtYXRjaDoiID4+JHtORVRDRkdfRklMRX0KICAgIGVjaG8gIiAgICAgICAgbWFjYWRkcmVzczogJE1BQyIgPj4ke05FVENGR19GSUxFfQogICAgIyB3cml0ZSBNVFUgaWYgaXQgaXMgc3VwcGxpZWQgYnkgdXNlcgogICAgaWYgW1sgJHtNVFV9ICE9ICJOT05FIiBdXTsgdGhlbgogICAgICAgIGVjaG8gIiAgICAgIG10dTogJHtNVFV9IiA+PiR7TkVUQ0ZHX0ZJTEV9CiAgICBmaQpmaSAgICAKZWNobyAiICB2ZXJzaW9uOiAyIiA+PiR7TkVUQ0ZHX0ZJTEV9Cm12ICR7TkVUQ0ZHX0ZJTEV9IC9ldGMvbmV0cGxhbi8KZWNobyAibmV0d29yazoge2NvbmZpZzogZGlzYWJsZWR9IiA+IDk5LWRpc2FibGUtbmV0d29yay1jb25maWcuY2ZnCm12IDk5LWRpc2FibGUtbmV0d29yay1jb25maWcuY2ZnIC9ldGMvY2xvdWQvY2xvdWQuY2ZnLmQvCmlmIFtbICR7SU5URVJGQUNFfSAhPSAibG8iIF1dOyB0aGVuCiAgICBjYXNlIGBncmVwIC1GICIke0lOVEVSRkFDRX0iIC9ldGMvbmV0cGxhbi8qLWNsb3VkLWluaXQueWFtbCA+L2Rldi9udWxsIDI+JjE7IGVjaG8gJD9gIGluCiAgICAwKQogICAgICAgICNpbnRlcmZhY2UgZm91bmQsIHNhZmUgdG8gcmVtb3ZlIGNsb3VkIGluaXQgZmlsZQogICAgICAgIHJtIC9ldGMvbmV0cGxhbi8qLWNsb3VkLWluaXQueWFtbCAyPi9kZXYvbnVsbAogICAgICAgIDs7CiAgICAxKQogICAgICAgICNpbiB0aGlzIGNhc2UsIHRoZSBpbnRlcmZhY2UgaW4gY2xvdWQtaW5pdCBpcyBkaWZmZXJlbnQKICAgICAgICBlY2hvIAogICAgICAgIGVjaG8gIi9ldGMvbmV0cGxhbi8qLWNsb3VkLWluaXQueWFtbCBjb250YWlucyBkaWZmZXJlbnQgaW50ZXJmYWNlIG5hbWUuIgogICAgICAgIGVjaG8gIlBsZWFzZSBjaGVjay4iCiAgICAgICAgZWNobwogICAgICAgIDs7CiAgICAqKQogICAgICAgICNUaGVyZSBhcmUgbm8gY2xvdWQtaW5pdCBmaWxlcy4gZG8gbm90aGluZwogICAgICAgIDs7CiAgICBlc2FjCmZpIApuZXRwbGFuIGFwcGx5CmVjaG8gIkNvbXBsZXRlIgplY2hvICJDcmVhdGVkIGZpbGUgL2V0Yy9uZXRwbGFuLzAxLW5ldGNmZy0ke0lOVEVSRkFDRX0ueWFtbCI="
  owner: root:root
  path: /opt/netfoundry/set-ip.sh
  permissions: '0755'
- encoding: b64
  content: "IyEvYmluL2Jhc2gKCmlmIFsgIiQxIiA9PSAibWFzdGVyIiBdOyB0aGVuCiAgICB6ZncgLUkgLWMgJChob3N0ICQoaG9zdG5hbWUpIHxhd2sgLUYnW1s6c3BhY2U6XV0rfD0nICd7cHJpbnQgJDR9JykgLW0gMzIgLW8gMC4wLjAuMCAtbiAwIC1sIDgwODEgLWggODA4MSAtdCAwIC1wIHRjcAplbGlmIFsgIiQxIiA9PSAiYmFja3VwIiBdOyB0aGVuCiAgICB6ZncgLUQgLWMgJChob3N0ICQoaG9zdG5hbWUpIHxhd2sgLUYnW1s6c3BhY2U6XV0rfD0nICd7cHJpbnQgJDR9JykgLW0gMzIgLW8gMC4wLjAuMCAtbiAwIC1sIDgwODEgLWggODA4MSAtdCAwIC1wIHRjcAplbHNlCiAgICBlY2hvICJubyB2YWxpZCBhcmd1bWVudCBwYXNzZWQiCmZpCg=="
  owner: root:root
  path: /opt/netfoundry/vrrp_notify.sh
  permissions: '0755'
- encoding: b64
  content: "Z2xvYmFsX2RlZnMgewogICAgICAgIHNjcmlwdF91c2VyIHppZ2d5IHppZ2d5CiAgICAgICAgZW5hYmxlX3NjcmlwdF9zZWN1cml0eQp9CnZycnBfc2NyaXB0IHdhbl9jaGVjayB7CiAgICAgICAgc2NyaXB0ICIvb3B0L25ldGZvdW5kcnkvZXJoY2hlY2tlci5weXoiCiAgICAgICAgaW50ZXJ2YWwgMwogICAgICAgIHJpc2UgMgogICAgICAgIGZhbGwgMgogICAgICAgIHVzZXIgemlnZ3kgemlnZ3kKfQp2cnJwX2luc3RhbmNlIFZJXzEgewogICAgICAgIGludGVyZmFjZSBlbnAwczUKICAgICAgICB2aXJ0dWFsX3JvdXRlcl9pZCA1MQogICAgICAgIGNoZWNrX3VuaWNhc3Rfc3JjCiAgICAgICAgdHJhY2tfc2NyaXB0IHsKICAgICAgICAgICAgICAgIHdhbl9jaGVjawogICAgICAgIH0KICAgICAgICBub3RpZnlfbWFzdGVyICIvb3B0L25ldGZvdW5kcnkvdnJycF9ub3RpZnkuc2ggbWFzdGVyIiByb290IHJvb3QKICAgICAgICBub3RpZnlfZmF1bHQgIi9vcHQvbmV0Zm91bmRyeS92cnJwX25vdGlmeS5zaCBiYWNrdXAiIHJvb3Qgcm9vdAp9"
  owner: root:root
  path: /etc/keepalived/keepalived.conf
  permissions: '0644'
- encoding: b64
  content: "IyEvYmluL2Jhc2gKCiMgVmFyaWFibGVzCkNMT1VEX1pJVElfSE9NRT0iL29wdC9uZXRmb3VuZHJ5IgpPUEVOX1pJVElfSE9NRT0iL29wdC9vcGVueml0aSIKWklUSV9IT01FPSIke0NMT1VEX1pJVElfSE9NRX0veml0aSIKWklUSV9DTEk9IiR7WklUSV9IT01FfS96aXRpIgpFQlBGX0JJTj0iJHtPUEVOX1pJVElfSE9NRX0vYmluIgoKIyBEaXZlcnRlciB1cGRhdGUgZnVuY3Rpb24gdG8gdGhlIGxhdGVzdCB2ZXJzaW9uCmRpdmVydGVyX3VwZGF0ZSgpIHsKICBpZiBbWyAkKCR7WklUSV9DTEl9IC0tdmVyc2lvbiB8IGN1dCAtZCJ2IiAtZiAyKSA+ICIwLjI3LjIiIF1dOyB0aGVuCiAgICBhcmNoPWB1bmFtZSAtbWAKICAgIGlmIFsgJGFyY2ggPT0gIng4Nl82NCIgXTsgdGhlbgogICAgICBhcmNoPSJhbWQ2NCIKICAgIGZpCiAgICBicm93c2VyX2Rvd25sb2FkX3VybD1gY3VybCAtcyBodHRwczovL2FwaS5naXRodWIuY29tL3JlcG9zL25ldGZvdW5kcnkvemZ3L3JlbGVhc2VzL2xhdGVzdCB8IGpxIC0tYXJnIGFyY2ggJGFyY2ggLXIgJy5hc3NldHNbXSB8IHNlbGVjdCgoLm5hbWUgfCB0ZXN0KCJyb3V0ZXIiKSkgYW5kICgubmFtZSB8IHRlc3QoJGFyY2gpKSkuYnJvd3Nlcl9kb3dubG9hZF91cmwnYAogICAgY3VybCAtc0wgJGJyb3dzZXJfZG93bmxvYWRfdXJsID4gL3RtcC96ZncuZGViCiAgICBzdWRvIGRwa2cgLWkgL3RtcC96ZncuZGViCiAgICBybSAvdG1wL3pmdy5kZWIKICAgIHN1ZG8gemZ3IC1RCiAgICBzdWRvIHN5c3RlbWN0bCByZXN0YXJ0IHppdGktcm91dGVyCiAgZWxzZQogICAgZWNobyAiSU5GTzogZWJwZiBjYW5ub3QgYmUgaW5zdGFsbGVkLCB0aGUgaW5zdGFsbGVkIHppdGkgdmVyc2lvbiBpcyBub3QgMC4yNy4zIG9yIGhpZ2hlci4iCiAgZmkKfQojIERpdmVydGVyIGVuYWJsZSBmdW5jdGlvbgpkaXZlcnRlcl9lbmFibGUoKSB7CiAgc3RhdHVzPWBkcGtnIC1zIHpmdy1yb3V0ZXIgMj4vZGV2L251bGxgCiAgaWYgW1sgYGVjaG8gJHN0YXR1cyB8YXdrIC1GJ1tbOnNwYWNlOl1dK3w9JyAne3ByaW50ICQ0fSdgID09ICJpbnN0YWxsIiBdXSAmJiBbWyAtZiAkRUJQRl9CSU4vc3RhcnRfZWJwZl9yb3V0ZXIucHkgXV07IHRoZW4KICAgIHN1ZG8gJEVCUEZfQklOL3N0YXJ0X2VicGZfcm91dGVyLnB5CiAgICBzdWRvIHN5c3RlbWN0bCByZXN0YXJ0IHppdGktcm91dGVyCiAgZWxzZSAKICAgIGVjaG8gJ0lORk86IGVicGYgbm90IGluc3RhbGxlZCwgcnVuIGRpdmVydGVyLXVwZGF0ZSB0byBpbnN0YWxsIGl0LicKICBmaQp9CiMgSGVhbHRoIENoZWNrZXIgU2NyaXB0IHVwZGF0ZSBmdW5jdGlvbiB0byB0aGUgbGF0ZXN0IHZlcnNpb24KZXJoY2hlY2tlcl91cGRhdGUoKSB7CiAgaWYgW1sgJCgke1pJVElfQ0xJfSAtLXZlcnNpb24gfCBjdXQgLWQidiIgLWYgMikgPiAiMC4yOC4wIiBdXTsgdGhlbgogICAgYXJjaD1gdW5hbWUgLW1gCiAgICBpZiBbICRhcmNoID09ICJ4ODZfNjQiIF07IHRoZW4KICAgICAgYXJjaD0iYW1kNjQiCiAgICBmaQogICAgYnJvd3Nlcl9kb3dubG9hZF91cmw9YGN1cmwgLXMgaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy9uZXRmb3VuZHJ5L2VkZ2Utcm91dGVyLWhlYWx0aC1jaGVja2VyL3JlbGVhc2VzL2xhdGVzdCB8IGpxIC0tYXJnIGFyY2ggJGFyY2ggLXIgJy5hc3NldHNbXSB8IHNlbGVjdCgubmFtZSB8IHRlc3QoJGFyY2gpKS5icm93c2VyX2Rvd25sb2FkX3VybCdgCiAgICBjdXJsIC1zTCAkYnJvd3Nlcl9kb3dubG9hZF91cmwgPiAvdG1wL2VyaGNoZWNrZXIudGFyLmd6CiAgICBzdWRvIHRhciB4emYgL3RtcC9lcmhjaGVja2VyLnRhci5neiAtQyAkQ0xPVURfWklUSV9IT01FCiAgICBybSAvdG1wL2VyaGNoZWNrZXIudGFyLmd6CiAgZWxzZQogICAgZWNobyAiSU5GTzogZXJoY2hlY2tlciBzY3JpcHQgY2Fubm90IGJlIGluc3RhbGxlZCwgdGhlIGluc3RhbGxlZCB6aXRpIHZlcnNpb24gaXMgbm90IDAuMjguMSBvciBoaWdoZXIuIgogIGZpCn0KCiMjIyBNYWluCmRpdmVydGVyX3VwZGF0ZQpkaXZlcnRlcl9lbmFibGUKZXJoY2hlY2tlcl91cGRhdGUK"
  owner: root:root
  path: /var/lib/cloud/diverter.sh
  permissions: '0755'
- content: |
    #Netfoundry Added file
    [Resolve]
    DNS=100.127.255.254
  owner: root:root
  path: /var/lib/cloud/01-netfoundry.conf
  permissions: '0644'
runcmd:
- |
  /opt/netfoundry/set-ip.sh -tp=static -ip=100.127.255.254 -pr=32 -in=lo -f
  LANIF="$(/sbin/ip -o link show up|awk '$9=="UP" {print $2;}'|head -1|tr -d ":")"
  /opt/netfoundry/router-registration --dnsIPRange ${s.dnsSvcIpRange} --tunnel_ip 100.127.255.254 --lanIf $LANIF ${s.edgeRouterKey}
  /var/lib/cloud/diverter.sh
  /usr/bin/systemctl restart keepalived.service
EOF
  ]
  flatten_list = {
        for item in flatten([
            for table in module.vpc1.public_route_table_ids : [
                for vm in module.compute_backend.*.id: {
                    vm = vm
                    table = table
                }
            ] 
        ])
        : item.vm => item
    }
}