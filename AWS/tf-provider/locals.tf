locals {
  aws_secret_name = "${random_string.random_secret_name.result}"
  er_map_be = [ for er in var.er_map_be:  merge(er, {region=var.region, awsSecretName=local.aws_secret_name})]
  user_data_be = [ for s in local.er_map_be : <<EOF
#cloud-config
package_update: true
packages:
  - keepalived
  - gh 
  - python3-pip
write_files:
- encoding: b64
  content: "IyEvYmluL2Jhc2gKCnNldCAtZQoKTVlJRj0kKC9zYmluL2lwIC1vIGxpbmsgc2hvdyB1cHxhd2sgJyQ5PT0iVVAiIHtwcmludCAkMjt9J3xoZWFkIC0xKQpNWUlQPSQoL3NiaW4vaXAgYWRkIHNob3cgIiR7TVlJRiU6fSJ8YXdrICckMT09ImluZXQiIHtwcmludCAkMjt9JykKCmlmIFsgIiQxIiA9PSAibWFzdGVyIiBdOyB0aGVuCiAgICB6ZncgLUkgLWMgJChlY2hvICRNWUlQIHxhd2sgLUYnLycgJ3twcmludCAkMX0nKSAtbSAzMiAtbyAwLjAuMC4wIC1uIDAgLWwgODA4MSAtaCA4MDgxIC10IDAgLXAgdGNwCmVsaWYgWyAiJDEiID09ICJiYWNrdXAiIF07IHRoZW4KICAgIHpmdyAtRCAtYyAkKGVjaG8gJE1ZSVAgfGF3ayAtRicvJyAne3ByaW50ICQxfScpIC1tIDMyIC1vIDAuMC4wLjAgLW4gMCAtbCA4MDgxIC1oIDgwODEgLXQgMCAtcCB0Y3AKZWxzZQogICAgZWNobyAibm8gdmFsaWQgYXJndW1lbnQgcGFzc2VkIgpmaQo="
  owner: root:root
  path: /opt/netfoundry/vrrp_notify.sh
  permissions: '0755'
- encoding: b64
  content: "Z2xvYmFsX2RlZnMgewogICAgICAgIHNjcmlwdF91c2VyIHppZ2d5IHppZ2d5CiAgICAgICAgZW5hYmxlX3NjcmlwdF9zZWN1cml0eQp9CnZycnBfc2NyaXB0IHdhbl9jaGVjayB7CiAgICAgICAgc2NyaXB0ICIvb3B0L25ldGZvdW5kcnkvZXJoY2hlY2tlci5weXoiCiAgICAgICAgaW50ZXJ2YWwgMwogICAgICAgIHJpc2UgMgogICAgICAgIGZhbGwgMgogICAgICAgIHVzZXIgemlnZ3kgemlnZ3kKfQp2cnJwX2luc3RhbmNlIFZJXzEgewogICAgICAgIGludGVyZmFjZSBlbnAwczUKICAgICAgICB2aXJ0dWFsX3JvdXRlcl9pZCA1MQogICAgICAgIGNoZWNrX3VuaWNhc3Rfc3JjCiAgICAgICAgdHJhY2tfc2NyaXB0IHsKICAgICAgICAgICAgICAgIHdhbl9jaGVjawogICAgICAgIH0KICAgICAgICBub3RpZnlfbWFzdGVyICIvb3B0L25ldGZvdW5kcnkvdnJycF9ub3RpZnkuc2ggbWFzdGVyIiByb290IHJvb3QKICAgICAgICBub3RpZnlfZmF1bHQgIi9vcHQvbmV0Zm91bmRyeS92cnJwX25vdGlmeS5zaCBiYWNrdXAiIHJvb3Qgcm9vdAp9"
  owner: root:root
  path: /etc/keepalived/keepalived.conf
  permissions: '0644'
- encoding: b64
  content: "IyEvYmluL2Jhc2gKCiMgVmFyaWFibGVzCkNMT1VEX1pJVElfSE9NRT0iL29wdC9uZXRmb3VuZHJ5IgpPUEVOX1pJVElfSE9NRT0iL29wdC9vcGVueml0aSIKWklUSV9IT01FPSIke0NMT1VEX1pJVElfSE9NRX0veml0aSIKWklUSV9DTEk9IiR7WklUSV9IT01FfS96aXRpIgpFQlBGX0JJTj0iJHtPUEVOX1pJVElfSE9NRX0vYmluIgoKIyBEaXZlcnRlciB1cGRhdGUgZnVuY3Rpb24gdG8gdGhlIGxhdGVzdCB2ZXJzaW9uCmRpdmVydGVyX3VwZGF0ZSgpIHsKICBpZiBbWyAkKCR7WklUSV9DTEl9IC0tdmVyc2lvbiB8IGN1dCAtZCJ2IiAtZiAyKSA+ICIwLjI3LjIiIF1dOyB0aGVuCiAgICBhcmNoPWB1bmFtZSAtbWAKICAgIGlmIFsgJGFyY2ggPT0gIng4Nl82NCIgXTsgdGhlbgogICAgICBhcmNoPSJhbWQ2NCIKICAgIGZpCiAgICBicm93c2VyX2Rvd25sb2FkX3VybD1gY3VybCAtcyBodHRwczovL2FwaS5naXRodWIuY29tL3JlcG9zL25ldGZvdW5kcnkvemZ3L3JlbGVhc2VzL2xhdGVzdCB8IGpxIC0tYXJnIGFyY2ggJGFyY2ggLXIgJy5hc3NldHNbXSB8IHNlbGVjdCgoLm5hbWUgfCB0ZXN0KCJyb3V0ZXIiKSkgYW5kICgubmFtZSB8IHRlc3QoJGFyY2gpKSkuYnJvd3Nlcl9kb3dubG9hZF91cmwnYAogICAgY3VybCAtc0wgJGJyb3dzZXJfZG93bmxvYWRfdXJsID4gL3RtcC96ZncuZGViCiAgICBzdWRvIGRwa2cgLWkgL3RtcC96ZncuZGViCiAgICBybSAvdG1wL3pmdy5kZWIKICAgIHN1ZG8gemZ3IC1RCiAgICBzdWRvIHN5c3RlbWN0bCByZXN0YXJ0IHppdGktcm91dGVyCiAgZWxzZQogICAgZWNobyAiSU5GTzogZWJwZiBjYW5ub3QgYmUgaW5zdGFsbGVkLCB0aGUgaW5zdGFsbGVkIHppdGkgdmVyc2lvbiBpcyBub3QgMC4yNy4zIG9yIGhpZ2hlci4iCiAgZmkKfQojIERpdmVydGVyIGVuYWJsZSBmdW5jdGlvbgpkaXZlcnRlcl9lbmFibGUoKSB7CiAgc3RhdHVzPWBkcGtnIC1zIHpmdy1yb3V0ZXIgMj4vZGV2L251bGxgCiAgaWYgW1sgYGVjaG8gJHN0YXR1cyB8YXdrIC1GJ1tbOnNwYWNlOl1dK3w9JyAne3ByaW50ICQ0fSdgID09ICJpbnN0YWxsIiBdXSAmJiBbWyAtZiAkRUJQRl9CSU4vc3RhcnRfZWJwZl9yb3V0ZXIucHkgXV07IHRoZW4KICAgIHN1ZG8gJEVCUEZfQklOL3N0YXJ0X2VicGZfcm91dGVyLnB5CiAgICBzdWRvIHN5c3RlbWN0bCByZXN0YXJ0IHppdGktCiAgICB6ZndfbG9nX2lzX2FjdGl2ZT1gc3lzdGVtY3RsIGlzLWFjdGl2ZSB6ZnctbG9nZ2luZy5zZXJ2aWNlYAogICAgemZ3X2xvZ19pc19lbmFibGVkPWBzeXN0ZW1jdGwgaXMtZW5hYmxlZCB6ZnctbG9nZ2luZy5zZXJ2aWNlYAogICAgaWYgW1sgIiR6ZndfbG9nX2lzX2FjdGl2ZSIgPT0gImluYWN0aXZlIiBdXTsgdGhlbgogICAgICBzdWRvIHN5c3RlbWN0bCBzdGFydCB6ZnctbG9nZ2luZy5zZXJ2aWNlCiAgICBmaQogICAgaWYgW1sgIiR6ZndfbG9nX2lzX2VuYWJsZWQiID09ICJkaXNhYmxlZCIgXV07IHRoZW4KICAgICAgc3VkbyBzeXN0ZW1jdGwgZW5hYmxlIHpmdy1sb2dnaW5nLnNlcnZpY2UKICAgIGZpCiAgZWxzZSAKICAgIGVjaG8gJ0lORk86IGVicGYgbm90IGluc3RhbGxlZCwgcnVuIGRpdmVydGVyLXVwZGF0ZSB0byBpbnN0YWxsIGl0LicKICBmaQp9CiMgSGVhbHRoIENoZWNrZXIgU2NyaXB0IHVwZGF0ZSBmdW5jdGlvbiB0byB0aGUgbGF0ZXN0IHZlcnNpb24KZXJoY2hlY2tlcl91cGRhdGUoKSB7CiAgaWYgW1sgJCgke1pJVElfQ0xJfSAtLXZlcnNpb24gfCBjdXQgLWQidiIgLWYgMikgPiAiMC4yOC4wIiBdXTsgdGhlbgogICAgYXJjaD1gdW5hbWUgLW1gCiAgICBpZiBbICRhcmNoID09ICJ4ODZfNjQiIF07IHRoZW4KICAgICAgYXJjaD0iYW1kNjQiCiAgICBmaQogICAgYnJvd3Nlcl9kb3dubG9hZF91cmw9YGN1cmwgLXMgaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy9uZXRmb3VuZHJ5L2VkZ2Utcm91dGVyLWhlYWx0aC1jaGVja2VyL3JlbGVhc2VzL2xhdGVzdCB8IGpxIC0tYXJnIGFyY2ggJGFyY2ggLXIgJy5hc3NldHNbXSB8IHNlbGVjdCgubmFtZSB8IHRlc3QoJGFyY2gpKS5icm93c2VyX2Rvd25sb2FkX3VybCdgCiAgICBjdXJsIC1zTCAkYnJvd3Nlcl9kb3dubG9hZF91cmwgPiAvdG1wL2VyaGNoZWNrZXIudGFyLmd6CiAgICBzdWRvIHRhciB4emYgL3RtcC9lcmhjaGVja2VyLnRhci5neiAtQyAkQ0xPVURfWklUSV9IT01FCiAgICBybSAvdG1wL2VyaGNoZWNrZXIudGFyLmd6CiAgZWxzZQogICAgZWNobyAiSU5GTzogZXJoY2hlY2tlciBzY3JpcHQgY2Fubm90IGJlIGluc3RhbGxlZCwgdGhlIGluc3RhbGxlZCB6aXRpIHZlcnNpb24gaXMgbm90IDAuMjguMSBvciBoaWdoZXIuIgogIGZpCn0KCiMjIyBNYWluCmRpdmVydGVyX3VwZGF0ZQpkaXZlcnRlcl9lbmFibGUKZXJoY2hlY2tlcl91cGRhdGUK"
  owner: root:root
  path: /var/lib/cloud/diverter.sh
  permissions: '0755'
- content: |
    #Netfoundry Added file
    [Resolve]
    DNS=100.127.255.254
  owner: root:root
  path: /var/lib/cloud/01-netfoundry.conf
  permissions: '0644'
- encoding: b64
  content: "IyEvdXNyL2Jpbi9weXRob24zCgppbXBvcnQgYm90bzMKZnJvbSBib3RvY29yZS5leGNlcHRpb25zIGltcG9ydCBDbGllbnRFcnJvcgppbXBvcnQgYXJncGFyc2UKCmRlZiBnZXRfc2VjcmV0KGFyZ3MpOgogICAgc2VjcmV0X25hbWUgPSBhcmdzLnNlY3JldF9uYW1lCiAgICByZWdpb25fbmFtZSA9IGFyZ3MucmVnaW9uX25hbWUKCiAgICBzZXNzaW9uID0gYm90bzMuc2Vzc2lvbi5TZXNzaW9uKCkKICAgIGNsaWVudCA9IHNlc3Npb24uY2xpZW50KAogICAgICAgIHNlcnZpY2VfbmFtZT0nc2VjcmV0c21hbmFnZXInLAogICAgICAgIHJlZ2lvbl9uYW1lPXJlZ2lvbl9uYW1lLAogICAgKQoKICAgIHRyeToKICAgICAgICBnZXRfc2VjcmV0X3ZhbHVlX3Jlc3BvbnNlID0gY2xpZW50LmdldF9zZWNyZXRfdmFsdWUoCiAgICAgICAgICAgIFNlY3JldElkPXNlY3JldF9uYW1lCiAgICAgICAgKQogICAgZXhjZXB0IENsaWVudEVycm9yIGFzIGU6CiAgICAgICAgaWYgZS5yZXNwb25zZVsnRXJyb3InXVsnQ29kZSddID09ICdSZXNvdXJjZU5vdEZvdW5kRXhjZXB0aW9uJzoKICAgICAgICAgICAgcHJpbnQoIlRoZSByZXF1ZXN0ZWQgc2VjcmV0ICIgKyBzZWNyZXRfbmFtZSArICIgd2FzIG5vdCBmb3VuZCIpCiAgICAgICAgZWxpZiBlLnJlc3BvbnNlWydFcnJvciddWydDb2RlJ10gPT0gJ0ludmFsaWRSZXF1ZXN0RXhjZXB0aW9uJzoKICAgICAgICAgICAgcHJpbnQoIlRoZSByZXF1ZXN0IHdhcyBpbnZhbGlkIGR1ZSB0bzoiLCBlKQogICAgICAgIGVsaWYgZS5yZXNwb25zZVsnRXJyb3InXVsnQ29kZSddID09ICdJbnZhbGlkUGFyYW1ldGVyRXhjZXB0aW9uJzoKICAgICAgICAgICAgcHJpbnQoIlRoZSByZXF1ZXN0IGhhZCBpbnZhbGlkIHBhcmFtczoiLCBlKQogICAgICAgIGVsaWYgZS5yZXNwb25zZVsnRXJyb3InXVsnQ29kZSddID09ICdEZWNyeXB0aW9uRmFpbHVyZSc6CiAgICAgICAgICAgIHByaW50KCJUaGUgcmVxdWVzdGVkIHNlY3JldCBjYW4ndCBiZSBkZWNyeXB0ZWQgdXNpbmcgdGhlIHByb3ZpZGVkIEtNUyBrZXk6IiwgZSkKICAgICAgICBlbGlmIGUucmVzcG9uc2VbJ0Vycm9yJ11bJ0NvZGUnXSA9PSAnSW50ZXJuYWxTZXJ2aWNlRXJyb3InOgogICAgICAgICAgICBwcmludCgiQW4gZXJyb3Igb2NjdXJyZWQgb24gc2VydmljZSBzaWRlOiIsIGUpCiAgICBlbHNlOgogICAgICAgICMgU2VjcmV0cyBNYW5hZ2VyIGRlY3J5cHRzIHRoZSBzZWNyZXQgdmFsdWUgdXNpbmcgdGhlIGFzc29jaWF0ZWQgS01TIENNSwogICAgICAgICMgRGVwZW5kaW5nIG9uIHdoZXRoZXIgdGhlIHNlY3JldCB3YXMgYSBzdHJpbmcgb3IgYmluYXJ5LCBvbmx5IG9uZSBvZiB0aGVzZSBmaWVsZHMgd2lsbCBiZSBwb3B1bGF0ZWQKICAgICAgICBpZiAnU2VjcmV0U3RyaW5nJyBpbiBnZXRfc2VjcmV0X3ZhbHVlX3Jlc3BvbnNlOgogICAgICAgICAgICByZXR1cm4gZ2V0X3NlY3JldF92YWx1ZV9yZXNwb25zZVsnU2VjcmV0U3RyaW5nJ10KICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gZ2V0X3NlY3JldF92YWx1ZV9yZXNwb25zZVsnU2VjcmV0QmluYXJ5J10KCiAgICAgICAgCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICBwYXJzZXIgPSBhcmdwYXJzZS5Bcmd1bWVudFBhcnNlcihkZXNjcmlwdGlvbj0iUmV0cmlldmUgYSBzZWNyZXQgZnJvbSBBV1MgU2VjcmV0cyBNYW5hZ2VyIikKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoIi0tc2VjcmV0LW5hbWUiLCByZXF1aXJlZD1UcnVlLCBoZWxwPSJUaGUgbmFtZSBvZiB0aGUgc2VjcmV0IikKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoIi0tcmVnaW9uLW5hbWUiLCBkZWZhdWx0PSJ1cy1lYXN0LTIiLCBoZWxwPSJUaGUgQVdTIHJlZ2lvbiAoZGVmYXVsdDogdXMtZWFzdC0yKSIpCiAgICBhcmdzID0gcGFyc2VyLnBhcnNlX2FyZ3MoKQogICAgcHJpbnQoZ2V0X3NlY3JldChhcmdzKSk="
  owner: root:root
  path: /opt/netfoundry/get_aws_secret.py
  permissions: '0755'
- encoding: b64
  content: "IyEvYmluL2Jhc2gKCi91c3IvYmluL2doIGF1dGggbG9naW4gLS13aXRoLXRva2VuIDw8PCQxCmFzc2V0PSQoL3Vzci9iaW4vZ2ggYXBpIC9yZXBvcy9uZXRmb3VuZHJ5L3pmdy9hY3Rpb25zL2FydGlmYWN0cyAtLWpxICcoIGxhc3QgKCguYXJ0aWZhY3RzIHwgc29ydF9ieSguY3JlYXRlZF9hdCkpLltdIHwgc2VsZWN0KC5uYW1lIHwgZW5kc3dpdGgoInJvdXRlci1hbWQ2NC1kZWIiKSkuYXJjaGl2ZV9kb3dubG9hZF91cmwpKScpCi91c3IvYmluL2N1cmwgLUxzICAiJGFzc2V0IiAgICAtSCAiQWNjZXB0OiBhcHBsaWNhdGlvbi92bmQuZ2l0aHViLnYzK2pzb24iICAgIC1IICJBdXRob3JpemF0aW9uOiBCZWFyZXIgJDEiICAtLW91dHB1dCAvb3B0L25ldGZvdW5kcnkvYXJ0aWZhY3QuemlwCi91c3IvYmluL3VuemlwICAtZCAvb3B0L25ldGZvdW5kcnkvIC9vcHQvbmV0Zm91bmRyeS9hcnRpZmFjdC56aXAKL3Vzci9iaW4vZHBrZyAtaSAvb3B0L25ldGZvdW5kcnkvemZ3LXJvdXRlcl8qX2FtZDY0LmRlYg=="
  owner: root:root
  path: /opt/netfoundry/dl_artifacts_zfw.sh
  permissions: '0755'
runcmd:
- |
  pip install boto3
  LANIF="$(/sbin/ip -o link show up|awk '$9=="UP" {print $2;}'|head -1|tr -d ":")"
  /usr/bin/ip address add 100.127.255.254/32 dev lo scope host
  /opt/netfoundry/router-registration --dnsIPRange ${s.dnsSvcIpRange} --tunnel_ip 100.127.255.254 --lanIf $LANIF ${s.edgeRouterKey}
  /var/lib/cloud/diverter.sh
  /opt/netfoundry/dl_artifacts_zfw.sh $(/opt/netfoundry/get_aws_secret.py --secret-name ${s.awsSecretName} --region-name ${s.region})
  /usr/bin/systemctl restart ziti-router.service
  /usr/bin/systemctl restart keepalived.service
EOF
  ]
  local_user_data_client = [ for er in var.er_map_be:  merge(er, {initialDelay=var.test_initital_delay, iterate=var.test_iterate_count})]
  user_data_client = [ for s in local.local_user_data_client : <<EOF
#cloud-config
package_update: 
write_files:
- encoding: b64
  content: "cGFja2FnZSBtYWluCgppbXBvcnQgKAoJImNyeXB0by90bHMiCgkiZW5jb2RpbmcvanNvbiIKCSJmbXQiCgkibG9nIgoJIm1hdGgiCgkibmV0L2h0dHAiCgkib3MiCgkidGltZSIKCgkiZ2l0aHViLmNvbS9zcGYxMy9jb2JyYSIKKQoKdmFyICgKCXNlcnZlclBvcnQgID0gODA4MQoJaXRlcmF0ZSAgICAgaW50Cgl0b3RhbF9pbmRleCA9IDAKCXRvdGFsXzIwMCAgID0gMAoKCWluaXRpYWxEZWxheSAgaW50Cglpbml0aWFsX2RlbGF5IHRpbWUuRHVyYXRpb24KCXVybHMgICAgICAgICAgPSBbXXN0cmluZ3sKCQkic2FwcGFzMDEuYXRjLmludGVybmFsIiwKCQkibGFtcGFwYXNycDEuc2FwLmxhbW9zYS5jb20iLAoJCSJsYWVkZGMwMS5zYXAubGFtb3NhLmNvbSIsCgkJIm10c3B3cGNuc2FwdnExMS5zYXAubm92aXMuY2wiLAoJCSJzYW1wbHByZHNhcDAxLnNhcC5zYWFtdGVybWluYWxzLmNvbSIsCgkJInVjbXBsY3Nwc2FwdnExMS5zYXAudWNtLmNsIiwKCQkidnA2cGFzMDEuYXRjLmludGVybmFsIiwKCQkibXNsZHdlY2RzYXB2dDExLnRlbmFudDAxLm5vdmlzLmNsIiwKCQkiY2QxcGFzMDEuYXRjLmludGVybmFsIiwKCQkibGFlYmtwMDEuc2FwLmxhbW9zYS5jb20iLAoJCSJza3Nkd2RlMHNhcHZxMTIuc2FwLm5vdmlzLmNsIiwKCQkid2oycGFzMDEuYXRjLmludGVybmFsIiwKCQkiandkcGFzMDEuYXRjLmludGVybmFsIiwKCQkibGhsbXNqbG1kYmouc2FwLmxhbW9zYS5jb20iLAoJCSJwcDJwYXMwMS5hdGMuaW50ZXJuYWwiLAoJCSJsYWpwYXAwMWRyLnNhcC5sYW1vc2EuY29tIiwKCQkibXRycHdjaW5ncnAuc2FwLm1ldHJvLmNsIiwKCQkiYmNobGJwb3Auc2FwLmJjZW50cmFsLmNsIiwKCQkibGFtZGFwYXNyZDEuc2FwLmxhbW9zYS5jb20iLAoJCS8vICJsbGVtcG9xamFzMDEuZ2NwLmxhZXVyb3BlYS5jb20ubXgiLAoJCSJzYXBwYXMwMS5hdGMuaW50ZXJuYWwiLAoJCSJyY2RwYXNmaXEuc2FwLnJjZGhvdGVscy5jb20iLAoJCSJsYW1xYXBhc3JxMS5zYXAubGFtb3NhLmNvbSIsCgkJImxhbHBkYzAxZHIuc2FwLmxhbW9zYS5jb20iLAoJCSJwcDFwYXMwMS5hdGMuaW50ZXJuYWwiLAoJCSJsbG1zc2NzanAxZHIuc2FwLmxhbW9zYS5jb20iLAoJCSJza3Nwd3ByMHNhcHZxMTIuc2FwLm5vdmlzLmNsIiwKCQkibGxtc3BkYjJqcDEuc2FwLmxhbW9zYS5jb20iLAoJCSJsbG1zcGxhYXNqY3Auc2FwLmxhbW9zYS5jb20iLAoJCSJiY2hkbHNjc3BvZC5zYXAuYmNlbnRyYWwuY2wiLAoJCSJlbmdkd2RjM3NhcHZ0MTEuc2FwLm5vdmlzLmNsIiwKCQkibGxtc3BsYXNjbHAxLnNhcC5sYW1vc2EuY29tIiwKCQkic2IycGFzMDEubm92aXNsYWJzLmludGVybmFsIiwKCQkiY2Q0cGFzMDEuYXRjLmludGVybmFsIiwKCQkiYmNocWxwYXNxYXMuc2FwLmJjZW50cmFsLmNsIiwKCQkibGxtc3BscGFhZXAxLnNhcC5sYW1vc2EuY29tIiwKCQkid3EycGFzMDEuYXRjLmludGVybmFsIiwKCQkiQkNIUExFUlBTQVAwNWwuU0FQLkJDRU5UUkFMLkNMIiwKCQkibGxtc3BkYjJqY3AxLnNhcC5sYW1vc2EuY29tIiwKCQkic2tzcXd0czBzYXB2cTEyLnNhcC5ub3Zpcy5jbCIsCgkJImxsbXNwYXNqY3Bkci5zYXAubGFtb3NhLmNvbSIsCgkJImJjaHBscGExcG9wLnNhcC5iY2VudHJhbC5jbCIsCgkJImxsbXNxcGFzamNxMS5zYXAubGFtb3NhLmNvbSIsCgkJIkJDSFBMRVJQU0FQMDEuc2FwLmJjZW50cmFsLmNsIiwKCQkibGhsbXNzbG1wYXMuc2FwLmxhbW9zYS5jb20iLAoJCSJudnNkd2RlY3NxbC5zYXBudnMubm92aXMuY2wiLAoJCSJudnNwd2NpbnByYy5zYXBudnMubm92aXMuY2wiLAoJCSJlbWJwbGhjY3NhcHZxMTEuc2FwLmVtYm9ub3IuY2wiLAoJCSJsbG1zcGxhYXNqcDEuc2FwLmxhbW9zYS5jb20iLAoJCSJsaGxtc2psbXNjcy5zYXAubGFtb3NhLmNvbSIsCgkJImxhbGRkYzAxLnNhcC5sYW1vc2EuY29tIiwKCQkicmNkcGFzZHBvLnNhcC5yY2Rob3RlbHMuY29tIiwKCQkibGxtc3BsZXJzbHAxLnNhcC5sYW1vc2EuY29tIiwKCQkid2ozcGFzMDEuYXRjLmludGVybmFsIiwKCQkibGFlcWRjMDEuc2FwLmxhbW9zYS5jb20iLAoJCSJtdHNkd2RjbnNhcHZxMTEuc2FwLm5vdmlzLmNsIiwKCQkidmFsbXNwbGNwMjAxLnNhcC5sYW1vc2EuY29tIiwKCQkibnZzcXdjaW50ZWMuc2FwbnZzLm5vdmlzLmNsIiwKCQkibGFjcWRjMDEuc2FwLmxhbW9zYS5jb20iLAoJCSJodzNwYXMwMS5hdGMuaW50ZXJuYWwiLAoJCSJiY2hxbHNjc3BvcS5zYXAuYmNlbnRyYWwuY2wiLAoJCSJza3Nkd2RlMHNhcHZ0MTEuc2FwLm5vdmlzLmNsIiwKCQkibGFjcGRjMDFkci5zYXAubGFtb3NhLmNvbSIsCgkJInVjbWRsZHBvc2FwdnExMS5zYXAudWNtLmNsIiwKCQkicmNkcGFzZGJ3LnNhcC5yY2Rob3RlbHMuY29tIiwKCQkidWNtcWxxcG9zYXB2cTExLnNhcC51Y20uY2wiLAoJCSJzcHRxbGNpbnFhcy5zYXAuc2FhbXRlcm1pbmFscy5jb20iLAoJCSJsYXdkZGMwMS5zYXAubGFtb3NhLmNvbSIsCgkJInNhcHNvbDAxLm5vdmlzbGFicy5pbnRlcm5hbCIsCgkJImVtYnBsaGNpc2FwdnExMS5zYXAuZW1ib25vci5jbCIsCgkJImxobG1zamxtcGFzLnNhcC5sYW1vc2EuY29tIiwKCQkic2FtcWxjaW5xYXMuc2FwLnNhYW0uY2wiLAoJCSJtc2xwd2VjcHNhcHZ0MTEudGVuYW50MDEubm92aXMuY2wiLAoJCSJoYTdwYXMwMS5hdGMuaW50ZXJuYWwiLAoJCSJza3Nxd3RzMHNhcHZ0MTEuc2FwLm5vdmlzLmNsIiwKCQkidnA2YXNjcy5hdGMuaW50ZXJuYWwiLAoJCSJzbG1wYXMwMS5hdGMuaW50ZXJuYWwiLAoJCSJsbG1zcHNjc2pjcDEuc2FwLmxhbW9zYS5jb20iLAoJCSJiY2hwbGEwNGVycC5zYXAuYmNlbnRyYWwuY2wiLAoJCSJ2aGJtbnNocWFzMDEuZ2NwLmJhbm9ydGUuY29tIiwKCQkicmNkcGFzZmlkLnNhcC5yY2Rob3RlbHMuY29tIiwKCQkibGF3cWRjMDEuc2FwLmxhbW9zYS5jb20iLAoJCSJwbzBwYXMwMS5hdGMuaW50ZXJuYWwiLAoJCSJudnNwd3NwYXNhcHZxMTEuc2VydmljaW8ubm92aXMuY2wiLAoJCSJlbmdwd3BjM3NhcHZ0MTEuc2FwLm5vdmlzLmNsIiwKCQkid2ozYXNjcy5hdGMuaW50ZXJuYWwiLAoJCSJsYW1wd3Njc3pwMS5zYXAubGFtb3NhLmNvbSIsCgkJIm52c3B3c3Bqc2FwdnExMS5zZXJ2aWNpby5ub3Zpcy5jbCIsCgkJImxsbXNwbGFwcGpwMS5zYXAubGFtb3NhLmNvbSIsCgkJIm10c3F3dGNuc2FwdnExMS5zYXAubm92aXMuY2wiLAoJCSJsbG1zcGFwcDE1LnNhcC5sYW1vc2EuY29tIiwKCQkibGxtc3BhcHAxNC5zYXAubGFtb3NhLmNvbSIsCgkJLy8gImxsZW1maXBhYXMwMS5nY3AubGFldXJvcGVhLmNvbS5teCIsCgkJInBvOXBhczAxLmF0Yy5pbnRlcm5hbCIsCgkJImJjaHBsYTAzZXJwLnNhcC5iY2VudHJhbC5jbCIsCgkJImxhanBhcDAxLnNhcC5sYW1vc2EuY29tIiwKCQkic2FtcGxjaW5wcmQuc2FwLnNhYW0uY2wiLAoJCSJ2YWxtc3BsZXAxMTEuc2FwLmxhbW9zYS5jb20iLAoJCSJsYWxwZGMwMS5zYXAubGFtb3NhLmNvbSIsCgkJIm52c2R3Y2luZGVjLnNhcG52cy5ub3Zpcy5jbCIsCgkJImZ0bGRscGFzZmR4LmF3cy5mZXJ0aW5hbC5jb20iLAoJCSJsYWpkYXAwMS5zYXAubGFtb3NhLmNvbSIsCgkJInJjZGhkYmRldi5zYXAucmNkaG90ZWxzLmNvbSIsCgkJIndkMXBhczAxLmF0Yy5pbnRlcm5hbCIsCgkJImJjaHFscGFzcG9xLnNhcC5iY2VudHJhbC5jbCIsCgkJImxsbXNwbHBhc2pjcC5zYXAubGFtb3NhLmNvbSIsCgkJInNmZnB3cHJzc2FwdnQxMi5zYXAub3RpY3NvZm9mYS5jbCIsCgkJInJzbmR3ZGVrc2FwdnExMS50ZW5hbnQwMS5ub3Zpcy5jbCIsCgkJInNwdHNsY2luZGV2LnNhcC5zYWFtdGVybWluYWxzLmNvbSIsCgkJInJjZHBhc3RzdC5zYXAucmNkaG90ZWxzLmNvbSIsCgkJInNmZmR3ZGVzc2FwdnQxMS5zYXAub3RpY3NvZm9mYS5jbCIsCgkJImp3ZGFzY3MuYXRjLmludGVybmFsIiwKCQkiajFkYXNjcy5hdGMuaW50ZXJuYWwiLAoJCSJyY2RwYXNkZXYuc2FwLnJjZGhvdGVscy5jb20iLAoJCSJ2aGJtbnNocGFzMDEuZ2NwLmJhbm9ydGUuY29tIiwKCQkibGxtc3FkYmFlcTEuc2FwLmxhbW9zYS5jb20iLAoJCSJsbG1zcGxhc2NqcDEuc2FwLmxhbW9zYS5jb20iLAoJCSJzYXBwYXMwMS5hdGMuaW50ZXJuYWwiLAoJCSJodGZwbHByZHBhcy5zYXAuaG9ydGlmcnV0LmNsIiwKCQkibGxtc3FzY3Nqd3ExLnNhcC5sYW1vc2EuY29tIiwKCQkicmNkaGRiZGJ3LnNhcC5yY2Rob3RlbHMuY29tIiwKCQkibGxtc3BsZXJzanAxLnNhcC5sYW1vc2EuY29tIiwKCQkid3EycGFzMDEuYXRjLmludGVybmFsIiwKCQkvLyAibGxlbXFzbGFhczAxLmdjcC5sYWV1cm9wZWEuY29tLm14IiwKCQkibnZzZHdhc2NkZWMuc2FwbnZzLm5vdmlzLmNsIiwKCQkibGxtc3BsZGJhbHAxLnNhcC5sYW1vc2EuY29tIiwKCQkibGxtc3BhcHAxNi5zYXAubGFtb3NhLmNvbSIsCgkJInNhcC1wcm9kLTMuc2FwLm5vdmlzLmNsIiwKCQkibGxtc3FzY3NqY3ExLnNhcC5sYW1vc2EuY29tIiwKCQkibG1zcGFzdGVzLnNhcC5sYW1vc2EuY29tIiwKCQkiajFkcGFzMDEuYXRjLmludGVybmFsIiwKCQkibGxtc3Bhc3NieC5zYXAubGFtb3NhLmNvbSIsCgkJImh0ZnBscHJkc2FwMDMuc2FwLmhvcnRpZnJ1dC5jbCIsCgkJImxsbXNzY3NqY3Bkci5zYXAubGFtb3NhLmNvbSIsCgkJIm1zbHF3ZWNxc2FwdnQxMS50ZW5hbnQwMS5ub3Zpcy5jbCIsCgkJInJjZGhkYnRzdC5zYXAucmNkaG90ZWxzLmNvbSIsCgkJImJjaHBscGEycG9wLnNhcC5iY2VudHJhbC5jbCIsCgkJInJzbnF3dGVrc2FwdnExMS50ZW5hbnQwMS5ub3Zpcy5jbCIsCgkJInNrc3B3cHIwc2FwdnQxMS5zYXAubm92aXMuY2wiLAoJCSJzYW1zbGNpbmRldi5zYXAuc2FhbS5jbCIsCgkJImVuZ3F3dGMzc2FwdnQxMS5zYXAubm92aXMuY2wiLAoJCSJ3ajJhc2NzLmF0Yy5pbnRlcm5hbCIsCgkJInNwdHNsYXNjZGV2LnNhcC5zYWFtdGVybWluYWxzLmNvbSIsCgkJLy8gImxsZW1wc2xhYXMwMS5nY3AubGFldXJvcGVhLmNvbS5teCIsCgkJImxsbXNwc2NzamNwMS5zYXAubGFtb3NhLmNvbSIsCgkJIndxM3BhczAxLmF0Yy5pbnRlcm5hbCIsCgkJImh0ZnBscHJkYXNjLnNhcC5ob3J0aWZydXQuY2wiLAoJCS8vICJsbGVtZXdxYWFzMDEuZ2NwLmxhZXVyb3BlYS5jb20ubXgiLAoJCSJsbG1zcXBhc2p3cTEuc2FwLmxhbW9zYS5jb20iLAoJCSJlbWJwbHNwcnNhcHZxMTEuc2FwLmVtYm9ub3IuY2wiLAoJCSJzZmZxd3Fhc3NhcHZ0MTEuc2FwLm90aWNzb2ZvZmEuY2wiLAoJCSJPWFFRV1RDVFNBUDAxLnNhcC5veGlxdWltLmNsIiwKCQkiQ0ZPUFdQQ0dTQVBWVDEzLnNhcC5jb3Jmby5jbCIsCgl9CgoJZG5zUmVzb2x2ZXJJUCAgICAgICAgPSAiMTAwLjEyNy4yNTUuMjU0OjUzIgoJZG5zUmVzb2x2ZXJQcm90byAgICAgPSAidWRwIgoJZG5zUmVzb2x2ZXJUaW1lb3V0TXMgPSA1MDAwCgllbmNvZGVyICAgICAgICAgICAgICBqc29uLkVuY29kZXIKKQoKdmFyIHJvb3RDbWQgPSAmY29icmEuQ29tbWFuZHsKCVVzZTogICAiaHR0cCIsCglTaG9ydDogIkEgc2ltcGxlIGh0dHAgdGVzdCBjbGllbnQiLAoJTG9uZzogICJBIHNpbXBsZSBodHRwIHRlc3QgY2xpZW50IiwKfQoKdmFyIHJ1bkNtZCA9ICZjb2JyYS5Db21tYW5kewoJVXNlOiAgICJydW4iLAoJU2hvcnQ6ICJydW4gdGVzdHMiLAoJTG9uZzogICJydW4gdGVzdHMiLAoJUnVuOiAgIHJ1blRlc3QsCn0KCmZ1bmMgaW5pdCgpIHsKCXJvb3RDbWQuQWRkQ29tbWFuZChydW5DbWQpCglydW5DbWQuRmxhZ3MoKS5JbnRWYXIoJml0ZXJhdGUsICJpdGVyYXRlIiwgMSwgIm51bWJlciBvZiB0ZXN0IGl0ZXJhdGlvbnMiKQoJcnVuQ21kLkZsYWdzKCkuSW50VmFyKCZpbml0aWFsRGVsYXksICJpbml0aWFsLWRlbGF5IiwgNSwgImluaXRpYWwgZGVsYXkgdG8gc3RhcnQgdGhlIHRlc3QgaW4gc2Vjb25kcyIpCn0KCmZ1bmMgY2FsY3VsYXRlKHMgZmxvYXQ2NCwgdCBmbG9hdDY0LCBwIGZsb2F0NjQpIGZsb2F0NjQgewoJdiA6PSAoKHMgLyB0KSAqIDEwMCkKCXIgOj0gbWF0aC5Qb3coMTAsIGZsb2F0NjQocCkpCglyZXR1cm4gbWF0aC5Sb3VuZCh2KnIpIC8gcgp9CgpmdW5jIHJ1blRlc3QoY21kICpjb2JyYS5Db21tYW5kLCBhcmdzIFtdc3RyaW5nKSB7CgoJaW5pdGlhbF9kZWxheSA9IHRpbWUuRHVyYXRpb24oaW5pdGlhbERlbGF5KQoJdGltZS5TbGVlcChpbml0aWFsX2RlbGF5ICogdGltZS5TZWNvbmQpCgoJaHR0cENsaWVudCA6PSAmaHR0cC5DbGllbnR7CgkJVHJhbnNwb3J0OiAmaHR0cC5UcmFuc3BvcnR7CgkJCVRMU0hhbmRzaGFrZVRpbWVvdXQ6IDEwICogdGltZS5TZWNvbmQsCgkJCVRMU0NsaWVudENvbmZpZzogICAgICZ0bHMuQ29uZmlne0luc2VjdXJlU2tpcFZlcmlmeTogdHJ1ZX0sCgkJfSwKCQlUaW1lb3V0OiA1ICogdGltZS5TZWNvbmQsCgl9CgoJZmlsZVBhdGggOj0gIi92YXIvbG9nL2h0dHBfdGVzdC5qc29uIgoJZmlsZSwgZXJyIDo9IG9zLk9wZW5GaWxlKGZpbGVQYXRoLCBvcy5PX1dST05MWXxvcy5PX0NSRUFURXxvcy5PX1RSVU5DLCAwNjQ0KQoJaWYgZXJyICE9IG5pbCB7CgkJbG9nLlByaW50ZigiRXJyb3Igb3BlbmluZyBmaWxlOiIsIGVycikKCQlyZXR1cm4KCX0KCWRlZmVyIGZpbGUuQ2xvc2UoKQoKCWZvciBpIDo9IDA7IGkgPD0gaXRlcmF0ZTsgaSsrIHsKCgkJZm9yIGosIHVybCA6PSByYW5nZSB1cmxzIHsKCgkJCXJlcXVlc3RVUkwgOj0gZm10LlNwcmludGYoImh0dHBzOi8vJXM6JWQvaGVhbHRoLWNoZWNrcyIsIHVybCwgc2VydmVyUG9ydCkKCQkJcmVxLCBlcnIgOj0gaHR0cC5OZXdSZXF1ZXN0KGh0dHAuTWV0aG9kR2V0LCByZXF1ZXN0VVJMLCBuaWwpCgkJCWlmIGVyciAhPSBuaWwgewoJCQkJbG9nLlByaW50ZigiY2xpZW50OiBjb3VsZCBub3QgY3JlYXRlIHJlcXVlc3Q6ICVzXG4iLCBlcnIpCgkJCQljb250aW51ZQoJCQl9CgkJCXJlcS5DbG9zZSA9IHRydWUKCgkJCXJlc3AsIGVyciA6PSBodHRwQ2xpZW50LkRvKHJlcSkKCQkJaWYgZXJyICE9IG5pbCB7CgkJCQlsb2cuUHJpbnRmKCJjbGllbnQ6IGVycm9yIG1ha2luZyBodHRwIHJlcXVlc3Q6ICVzXG4iLCBlcnIpCgkJCQljb250aW51ZQoJCQl9CgoJCQlkZWZlciByZXNwLkJvZHkuQ2xvc2UoKQoJCQl0b3RhbF9pbmRleCA9IGogKyAxICsgaSpsZW4odXJscykKCQkJZW5jb2RlciA9ICpqc29uLk5ld0VuY29kZXIoZmlsZSkKCQkJZW5jb2Rlci5FbmNvZGUodG90YWxfaW5kZXgpCgkJCWVuY29kZXIuRW5jb2RlKHJlc3AuU3RhdHVzQ29kZSkKCQkJZW5jb2Rlci5FbmNvZGUocmVzcC5IZWFkZXJbIkRhdGUiXSkKCQkJZW5jb2Rlci5FbmNvZGUocmVzcC5SZXF1ZXN0LlVSTC5Ib3N0KQoJCQlpZiByZXNwLlN0YXR1c0NvZGUgPT0gMjAwIHsKCQkJCXRvdGFsXzIwMCsrCgkJCX0KCQl9CgoJfQoKCWF2YWlsYWJpbGl0eSA6PSBjYWxjdWxhdGUoZmxvYXQ2NCh0b3RhbF8yMDApLCBmbG9hdDY0KHRvdGFsX2luZGV4KSwgMykKCWlmIGF2YWlsYWJpbGl0eSA+IDk5Ljk1MCB7CgkJZW5jb2Rlci5FbmNvZGUoZm10LlNwcmludGYoIlRlc3QgUGFzc2VkIHdpdGggYXZhaWxhYmlsaXR5IHJhdGUgb2YgJS4zZiBwZXJjZW50IiwgYXZhaWxhYmlsaXR5KSkKCX0gZWxzZSB7CgkJZW5jb2Rlci5FbmNvZGUoZm10LlNwcmludGYoIlRlc3QgRmFpbGVkIHdpdGggYXZhaWxhYmlsaXR5IHJhdGUgb2YgJS4zZiBwZXJjZW50IiwgYXZhaWxhYmlsaXR5KSkKCX0KCn0KCmZ1bmMgbWFpbigpIHsKCglpZiBlcnIgOj0gcm9vdENtZC5FeGVjdXRlKCk7IGVyciAhPSBuaWwgewoJCWZtdC5QcmludGxuKGVycikKCQlvcy5FeGl0KDEpCgl9Cgp9Cg=="
  owner: root:root
  path: /opt/netfoundry/http.go
  permissions: '0755'
users:
- name: ziggy
  groups: sudo
  sudo: ['ALL=(ALL:ALL) NOPASSWD:ALL']
  shell: /bin/bash
  home: /home/ziggy
  ssh_authorized_keys:
  - ${var.ssh_public_key}
runcmd:
- |
  sed -i 's/#DNS=/DNS=100.127.255.254/g' /etc/systemd/resolved.conf
  /usr/bin/systemctl restart systemd-resolved.service
  curl -L https://go.dev/dl/go1.22.5.linux-amd64.tar.gz -o /tmp/go1.22.5.linux-amd64.tar.gz
  tar -C /usr/local -xzf /tmp/go1.22.5.linux-amd64.tar.gz
  rm /tmp/go1.22.5.linux-amd64.tar.gz
  export PATH=$PATH:/usr/local/go/bin
  export GOCACHE='/opt/netfoundry/.cache/go-build'
  export GOPATH='/opt/netfoundry/go'
  export GOROOT='/usr/local/go'
  cd /opt/netfoundry/
  /usr/local/go/bin/go mod init http
  /usr/local/go/bin/go mod tidy
  /usr/local/go/bin/go build
  nohup /opt/netfoundry/http run --initial-delay ${s.initialDelay} --iterate ${s.iterate} > /var/log/http.log 2>&1 &
EOF
  ]
}
